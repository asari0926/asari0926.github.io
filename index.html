<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒ³ãƒˆç®¡ç†</title>
    <link rel="stylesheet" href="styles.css"> <!-- ğŸ”¹CSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
</head>
<body>
    <h1>ãƒã‚¤ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

    <label for="userSelect"><strong>èª°ã‚’é¸æŠ:</strong></label>
    <select id="userSelect">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ãƒãƒ">ãƒãƒ</option>
        <option value="ãŠçˆ¶ã•ã‚“">ãŠçˆ¶ã•ã‚“</option>
    </select>

    <h2>å–å¼•å±¥æ­´</h2>
    <table>
        <thead>
            <tr>
                <th>æ—¥ä»˜</th>
                <th>æ”¯æ‰•ã„</th>
                <th>ãƒã‚¤ãƒ³ãƒˆ</th>
                <th>ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨</th> <!-- ğŸ”¹ è¿½åŠ  -->
            </tr>
        </thead>
        <tbody id="historyTable">
        </tbody>
    </table>

    <h2>æ®‹ã‚Šãƒã‚¤ãƒ³ãƒˆ: <span id="remainingPoints">-</span></h2>

    <script>
        const apiUrl = "https://script.google.com/macros/s/AKfycbw-XEW-la9v5rEZCMWt6LgBQiUFDrZiloAiAlNQrNiT_zEG8z71NyRVvGUu39Z2LACbfA/exec";

        async function fetchData() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

                const data = await response.json();
                console.log("å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:", data);
                return data;
            } catch (error) {
                console.error("ã‚¨ãƒ©ãƒ¼:", error);
                return null;
            }
        }

        document.getElementById("userSelect").addEventListener("change", async function() {
            const selectedUser = this.value;
            if (!selectedUser) {
                document.getElementById("historyTable").innerHTML = "";
                document.getElementById("remainingPoints").textContent = "-";
                return;
            }

            const data = await fetchData();
            if (!data || !data[selectedUser]) {
                console.error("é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }

            console.log(`é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼: ${selectedUser}`, data[selectedUser]);

            const userData = data[selectedUser];

            // ğŸ”¹ ã€Œãƒã‚¤ãƒ³ãƒˆä½¿ç”¨ã€ã‚‚è€ƒæ…®ã—ã¦æ®‹ã‚Šãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
            const totalPoints = userData.transactions.reduce((sum, t) => sum + t.points, 0);
            const usedPoints = userData.transactions.reduce((sum, t) => sum + (t.usedPoints || 0), 0);
            const remainingPoints = totalPoints - usedPoints;

            document.getElementById("remainingPoints").textContent = remainingPoints;

            // å–å¼•å±¥æ­´ã®è¡¨ç¤º
            const historyTable = document.getElementById("historyTable");
            historyTable.innerHTML = "";

            userData.transactions.forEach(transaction => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>${transaction.payment}</td>
                    <td>${transaction.points}</td>
                    <td>${transaction.usedPoints || 0}</td> <!-- ğŸ”¹ è¿½åŠ  -->
                `;
                historyTable.appendChild(row);
            });
        });
    </script>
</body>
</html>
